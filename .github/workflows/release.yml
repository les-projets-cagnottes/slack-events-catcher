name: Release

on:
  release:
    types: [created]

jobs:

  publish-gpr:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v1
      - uses: actions/setup-node@v1
        with:
          node-version: 12
          registry-url: https://npm.pkg.github.com/
          scope: '@les-projets-cagnottes'
      - run: npm ci
      - run: npm config set registry https://npm.pkg.github.com/
      - run: echo '//npm.pkg.github.com/:_authToken=${{secrets.GITHUB_TOKEN}}' > .npmrc
      - run: npm publish
        env:
          NODE_AUTH_TOKEN: ${{secrets.GITHUB_TOKEN}}

  publish-npm:
    needs: publish-gpr
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v1
      - uses: actions/setup-node@v1
        with:
          node-version: 12
          registry-url: https://registry.npmjs.org/
      - run: npm ci
      - run: npm publish
        env:
          NODE_AUTH_TOKEN: ${{secrets.npm_token}}


  deploy-prod:
    runs-on: ubuntu-latest
    steps:

    - uses: actions/checkout@v1

    - name: Copy content recursively to production
      uses: garygrossgarten/github-action-scp@v0.5.3
      with:
        local: .
        remote: ${{ secrets.PRODUCTION_PATH }}
        host: ${{ secrets.PRODUCTION_HOST }}
        username: ${{ secrets.PRODUCTION_USER }}
        privateKey : ${{ secrets.PRODUCTION_KEY }}
        
    - name: executing remote ssh commands using password
      uses: appleboy/ssh-action@v0.0.6
      with:
        host: ${{ secrets.PRODUCTION_HOST }}
        username: ${{ secrets.PRODUCTION_USER }}
        key : ${{ secrets.PRODUCTION_KEY }}
        port: ${{ secrets.PRODUCTION_PORT }}
        script: (nohup ${{ secrets.PRODUCTION_PATH }}/bin/deploy.sh > console.out 2> console.err < /dev/null &) && exit 0
